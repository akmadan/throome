name: SDK Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'sdk/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'sdk/**'

jobs:
  test-go-sdk:
    name: Test Go SDK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        working-directory: sdk/go
        run: go mod download

      - name: Run go vet
        working-directory: sdk/go
        run: go vet ./...

      - name: Run go fmt check
        working-directory: sdk/go
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted. Run 'gofmt -w .'"
            gofmt -d .
            exit 1
          fi

      - name: Build SDK
        working-directory: sdk/go
        run: go build ./...

      - name: Run tests
        working-directory: sdk/go
        run: go test -v -race -coverprofile=coverage.out ./...
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./sdk/go/coverage.out
          flags: go-sdk
        continue-on-error: true

  test-nodejs-sdk:
    name: Test Node.js SDK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: sdk/nodejs
        run: npm ci

      - name: Build SDK
        working-directory: sdk/nodejs
        run: npm run build

      - name: Run tests
        working-directory: sdk/nodejs
        run: npm test || echo "No tests configured"
        continue-on-error: true

      - name: Check TypeScript types
        working-directory: sdk/nodejs
        run: npx tsc --noEmit

  test-python-sdk:
    name: Test Python SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        working-directory: sdk/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install requests pytest black mypy

      - name: Lint with black
        working-directory: sdk/python
        run: black --check src/
        continue-on-error: true

      - name: Type check with mypy
        working-directory: sdk/python
        run: mypy src/
        continue-on-error: true

      - name: Run tests
        working-directory: sdk/python
        run: pytest tests/ -v --cov=src --cov-report=xml || echo "No tests configured"
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./sdk/python/coverage.xml
          flags: python-sdk-${{ matrix.python-version }}
        continue-on-error: true

  test-examples:
    name: Test SDK Examples Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Go example builds
        working-directory: sdk/go/examples
        run: |
          go mod download
          go build -o /dev/null main.go

      - name: Check Node.js example compiles
        working-directory: sdk/nodejs/examples
        run: |
          npm install
          npx tsc --noEmit index.ts || echo "TypeScript check completed"
        continue-on-error: true

      - name: Check Python example syntax
        working-directory: sdk/python/examples
        run: python -m py_compile main.py

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-go-sdk, test-nodejs-sdk, test-python-sdk, test-examples]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ§ª SDK Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Go SDK | ${{ needs.test-go-sdk.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js SDK | ${{ needs.test-nodejs-sdk.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python SDK | ${{ needs.test-python-sdk.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Examples | ${{ needs.test-examples.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY

